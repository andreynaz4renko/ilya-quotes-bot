import { Telegraf, Context } from "telegraf";

// –°–ø–∏—Å–æ–∫ –Ω–∞–∑–≤–∞–Ω–∏–π —Ü–∏—Ç–∞—Ç
const QUOTE_NAMES = [
  "üò§ –ë–ª—è—Ç—å, –í–∞–ª–∏–∫–æ–Ω–∏—Ç–µ, –∑–∞–µ–±–∞–ª–∞, –±–ª—è—Ç—å, –æ—Ä–∞—Ç—å",
  "üò° –°—É–∫–∞, –∑–∞–∫—Ä–æ–π—Ç–µ —Å–≤–æ–∏ –µ–±–ª–∞–∫–∏, –Ω–∞—Ö—É–π, –±–ª—è—Ç—å",
  "ü§¨ –ò–î–ò –ù–ê–•–£–ô, –ë–õ–Ø–¢–¨",
  "üò† –ë–ª—è—Ç—å, —Å—É–∫–∞, –∫–∞–∫ —Ç—ã –º–µ–Ω—è –∑–∞–µ–±–∞–ª, –ø—Ä–æ—Å—Ç–æ",
  "üí• –ë–ª—è—Ç—å, –¥–∞ –∫–∞–∫ –Ω–µ –±–æ–º–±–∏—Ç—å —Ç–æ?",
  "ü§Ø –î–∞ –±–ª—è—Ç—å, –ø–∏–∑–¥–∞, –Ω–∞—Ö—É–π",
  "üòÖ –ë–ª—è—Ç—å, –Ω–µ —Ç—É–¥–∞",
  "üëç –•–æ—Ä–æ—à–æ, –±–ª—è—Ç—å, –Ω–µ –¥–æ–ø—É—Å–∫–∞–π, –Ω–∞—Ö—É–π",
  "üò§ –î–∞ –±–ª—è—Ç—å... —Å—É–∫–∞",
  "ü§∑ –ë–ª—è—Ç—å... –≤–æ—Ç... –Ω–∞—Ö—É–π...",
  "‚úÖ –•–æ—Ä–æ—à–æ, —Ö–æ—Ä–æ—à–æ, –±–ª—è—Ç—å",
  "üòî –î–æ–ø—É—Å—Ç–∏–ª, –±–ª—è—Ç—å, —Å—É–∫–∞",
  "‚ú® –ï–±–∞—Ç—å. –û—Ö—É–µ–Ω–Ω–æ–µ —á—É–¥–æ, –Ω–∞—Ö—É–π, —Å–ø—É—Å—Ç–∏–ª–æ—Å—å —Å –Ω–µ–±–µ—Å",
  "üî• –ë–ª–∞–≥–æ–¥–∞—Ç–Ω—ã–π –æ–≥–æ–Ω—å –≤–∑–æ—à—ë–ª",
  "ü§´ –ë–ª—è—Ç—å, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –º–æ–∂–µ—à—å –ø–æ–º–æ–ª—á–∞—Ç—å?",
  "üôè –ü–æ–∂–∞–ª—É–π—Å—Ç–∞",
  "ü§î –ß—ë —Ç—ã –¥–∞, –±–ª—è—Ç—å?",
  "üòê –û–Ω–∏ –Ω–µ —Ö–æ—Ç–µ–ª–∏... –∫–∞–∫ –±—ã... –ø–æ—Ä—Ç–∏—Ç—å —Å —Ç–æ–±–æ–π –æ—Ç–Ω–æ—à–µ–Ω–∏—è",
  "üòè –¢–∏–ø–æ –ø—Ä–æ —Ö—É–π –ø–æ—à—É—Ç–∏–ª",
  "üí™ –í–æ, –µ–±–∞—Ç—å, –≤–æ—Ç —ç—Ç–æ –ø–æ–¥–¥–µ—Ä–∂–∫–∞",
  "üëè –í–æ—Ç –≤–∏–¥–∏—Ç–µ –∫–∞–∫ –Ω–∞–¥–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –æ–¥–Ω–æ–≥—Ä—É–ø–ø–Ω–∏–∫–æ–≤?",
  "üëç –î–∞, –±–ª—è—Ç—å",
  "ü§Ø –ü–∏–∑–¥–µ—Ü, –±–ª—è—Ç—å... –Ω—É –±–ª—è... –æ—Ö—É–µ–Ω–Ω–æ, –±–ª—è—Ç—å, –≤–æ–æ–±—â–µ... —è –µ–±–∞–ª, –±–ª—è—Ç—å",
  "üò§ –ù—É –±–ª—è—Ç—å, –Ω—É –∫–∞–∫ —Ç–∞–∫ –≤–æ–æ–±—â–µ, –±–ª—è—Ç—å?",
  "ü§ê –Ø –Ω–∏–∫–æ–º—É –Ω–µ —Å–∫–∞–∂—É",
  "üëã –ü–æ—à—ë–ª –Ω–∞—Ö—É–π, –±–ª—è—Ç—å!",
  "ü§∑ –ò–ª–∏ –∫—É–¥–∞, –±–ª—è—Ç—å?",
  "üò§ –ë–ª—è—Ç—å, —Å—É–∫–∞, –ø—Ä–æ—Å—Ç–æ, —è –µ–±–∞–ª",
  "ü§™ –ë–ª—è—Ç—å, –ø—Ä–æ—Å—Ç–æ, –≤—ã –µ–±–∞–Ω—É—Ç—ã–µ, –Ω–∞—Ö—É–π",
  "ü§¶ –ë–ª—è—Ç—å, –Ω—É –∫–∞–∫? –ö–∞–∫ —Ç–∞–∫–∏–º–∏ —Ç—É–ø—ã–º–∏ –ø—ë–∑–¥–∞–º–∏ –º–æ–∂–Ω–æ, –±–ª—è—Ç—å, –±—ã—Ç—å, –ø—Ä–æ—Å—Ç–æ?",
  "üëä –°—É–∫–∞, –∫—Ç–æ –≤—ã–π–¥–µ—Ç –æ—Ç—Å—é–¥–∞ - –ø–æ–ª—É—á–∏—Ç –ø–æ –µ–±–∞–ª—É",
  "üòé –ò–∑–∏, –±–ª—è—Ç—å",
  "üî• –ï–±–∞—Ç—å, –∂–æ—Å–∫–∏–µ –º–µ–º—ã",
  "üëç –•–æ—Ä–æ—à–æ, —Ö–æ—Ä–æ—à–æ",
  "üôè –°–ø–∞—Å–∏–±–æ",
  "‚úã –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ —â–∞—Å, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∏—á–µ–≥–æ",
  "üòè –ù–∞–µ–±–∞–ª",
  "üò± –≠—Ç–æ –µ–±–∞–ª–æ –æ—Ä—É—â–µ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞, –Ω–∞—Ö—É–π. –°–º–æ—Ç—Ä–∏—Ç–µ, –±–ª—è—Ç—å",
  "üëÄ –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –∫–∞–∫ –æ–Ω –æ—Ä—ë—Ç!",
  "ü§î –ö–∞–≤–æ, –Ω–∞—Ö—É–π? –û–∫–Ω–æ?",
  "üëØ –í–æ—Ç, –ù–∞—Å—Ç—è, –º—ã —Å —Ç–æ–±–æ–π –ø–æ—Ö–æ–∂–∏",
  "üò§ –î–∞ –±–ª—è—Ç—å, –∑–∞–µ–±–∞–ª, –Ω–∞—Ö—É–π",
  "üí≥ –ö–∞—Ä—Ç—É –∫–∏–¥–∞–π",
  "üìû –°–ª—ã—à, –±–ª—è—Ç—å? –î–∞–≤–∞–π, –Ω–∞—Ö—É–π, –ø–æ–¥—ä–µ–∑–∂–∞–π, –±–ª—è—Ç—å",
  "ü§ù –†–∞–∑–±–µ—Ä—ë–º—Å—è –ø–æ-–ø–∞—Ü–∞–Ω—Å–∫–∏",
  "üòå –≠—Ç–æ... –ù–∞—Å—Ç—å... –Ω—É —Ç—ã —ç—Ç–æ... –Ω–µ –ø—Å–∏—Ö—É–π",
  "üßò –£—Å–ø–æ–∫–æ–π—Å—è",
  "üéâ –ù—É –±–ª—è—Ç—å, –Ω—É –ª–∞–¥–Ω–æ, –Ω—É –≤–æ–æ–±—â–µ... –≠—Ç–æ —Ö–æ—Ä–æ—à–∞—è –Ω–æ–≤–æ—Å—Ç—å, –≤–æ–æ–±—â–µ, –ø—Ä—è–º!",
  "üò≥ –ù–∏—Ö—É—è, –Ω–∏—Ö—É—è, –Ω–∏—Ö—É—è, –Ω–∏—Ö—É—è",
  "‚ùå –¢—ã —Å–∫–∞–∑–∞–ª–∞ '–ù–µ—Ç'",
  "ü§∑ –í —á—ë–º –ø—Ä–∏–∫–æ–ª?",
  "üéå –ù—É —á—ë, –ø–∞—Ü–∞–Ω—ã, –±–ª—è—Ç—å? –ê–Ω–∏–º—ç?",
  "üò§ –ë–ª—è—Ç—å, –∑–∞–µ–±–∞–ª!",
];

export class Bot {
  private bot: Telegraf;
  private readonly STORAGE_BASE_URL =
    "https://storage.yandexcloud.net/priemka-storage";

  constructor(token: string) {
    this.bot = new Telegraf(token);
    this.setupHandlers();
  }

  private setupHandlers(): void {
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
    this.bot.start((ctx: Context) => {
      ctx.reply(
        "–ü—Ä–∏–≤–µ—Ç! –Ø –∏–Ω–ª–∞–π–Ω-–±–æ—Ç –¥–ª—è —Ü–∏—Ç–∞—Ç –ò–ª—å–∏.\n\n" +
          "–ò—Å–ø–æ–ª—å–∑—É–π –º–µ–Ω—è –≤ –ª—é–±–æ–º —á–∞—Ç–µ: –Ω–∞—á–Ω–∏ –≤–≤–æ–¥–∏—Ç—å @–∏–º—è_–±–æ—Ç–∞ –∏ –≤—ã–±–µ—Ä–∏ –Ω—É–∂–Ω—É—é —Ü–∏—Ç–∞—Ç—É –∏–∑ —Å–ø–∏—Å–∫–∞."
      );
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help
    this.bot.help((ctx: Context) => {
      ctx.reply(
        "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n" +
          "/start - –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –±–æ—Ç–æ–º\n" +
          "/help - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É\n\n" +
          "–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏–Ω–ª–∞–π–Ω-—Ä–µ–∂–∏–º–∞:\n" +
          "1. –ù–∞—á–Ω–∏ –≤–≤–æ–¥–∏—Ç—å @–∏–º—è_–±–æ—Ç–∞ –≤ –ª—é–±–æ–º —á–∞—Ç–µ\n" +
          "2. –í—ã–±–µ—Ä–∏ –Ω—É–∂–Ω—É—é —Ü–∏—Ç–∞—Ç—É –∏–∑ —Å–ø–∏—Å–∫–∞\n" +
          "3. –û—Ç–ø—Ä–∞–≤—å –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"
      );
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–Ω–ª–∞–π–Ω-–∑–∞–ø—Ä–æ—Å–æ–≤
    this.bot.on("inline_query", async (ctx) => {
      const query = ctx.inlineQuery?.query?.toLowerCase() || "";

      // –§–∏–ª—å—Ç—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      const filteredQuotes = QUOTE_NAMES.map((name, index) => ({
        name,
        index,
      })).filter(({ name }) => name.toLowerCase().includes(query));

      // –°–æ–∑–¥–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è –∏–Ω–ª–∞–π–Ω-–∑–∞–ø—Ä–æ—Å–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º URL –∏–∑ Yandex Cloud Storage
      // Telegram –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–æ 50
      const results = filteredQuotes.slice(0, 50).map(({ name, index }) => {
        // –§–æ—Ä–º–∏—Ä—É–µ–º URL –¥–ª—è —Ñ–∞–π–ª–∞ –∏–∑ Yandex Cloud Storage
        const fileUrl = `${this.STORAGE_BASE_URL}/a${index}.ogg`;

        return {
          type: "voice" as const,
          id: `quote_${index}`,
          title: name,
          voice_url: fileUrl,
        };
      });

      try {
        await ctx.answerInlineQuery(results, {
          cache_time: 3600, // –ö—ç—à–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–∞ 1 —á–∞—Å
        });
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∏–Ω–ª–∞–π–Ω-—Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:", error);
      }
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏)
    this.bot.on("chosen_inline_result", (ctx) => {
      const resultId = ctx.chosenInlineResult?.result_id;
      if (resultId) {
        const index = parseInt(resultId.replace("quote_", ""));
        console.log(
          `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª —Ü–∏—Ç–∞—Ç—É #${index}: ${QUOTE_NAMES[index]}`
        );
      }
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
    this.bot.catch((err: any, ctx: Context) => {
      console.error(`–û—à–∏–±–∫–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${ctx.from?.id}:`, err);
      if (ctx.callbackQuery || ctx.inlineQuery) {
        // –î–ª—è –∏–Ω–ª–∞–π–Ω-–∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
        return;
      }
      ctx.reply("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
    });
  }

  public start(): void {
    this.bot
      .launch()
      .then(() => {
        console.log("–ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!");
      })
      .catch((error) => {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞:", error);
        process.exit(1);
      });

    // Graceful shutdown
    process.once("SIGINT", () => this.stop("SIGINT"));
    process.once("SIGTERM", () => this.stop("SIGTERM"));
  }

  private stop(signal: string): void {
    console.log(`–ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª ${signal}, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–æ—Ç–∞...`);
    this.bot.stop(signal);
    process.exit(0);
  }
}
